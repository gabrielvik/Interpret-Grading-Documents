@model Interpret_grading_documents.Services.GPTService.GraduationDocument;

@if (Model != null)
{
        <h2 class="mt-4">Review the Data for @Model.FullName</h2>
        <p>Please review the extracted data below and make any necessary corrections. It is important that the information is accurate.</p>

        <h3 class="mt-4">Image Reliability</h3>
        <div class="card mt-2">
            <div class="card-body">
                <p class="card-text"><strong>Reliability Score:</strong> @Model.ImageReliability.ReliabilityScore.ToString("F2")%</p>
                <p class="card-text"><strong>File Format:</strong> @Model.ImageReliability.FileFormat</p>
            </div>
        </div>

        @if (Model.ImageReliability.ReliabilityScore > 0)
        {
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Student Information</h5>

                    <p class="card-text">
                        <strong>Full Name:</strong>
                        <span class="editable-cell student-info" data-field="FullName">
                            @Model.FullName
                        </span>
                        <small class="form-text text-muted">(Click to edit)</small>
                    </p>

                    <p class="card-text">
                        <strong>Social Security Number:</strong>
                        <span class="editable-cell student-info" data-field="PersonalId">
                            @Model.PersonalId
                        </span>
                        <small class="form-text text-muted">(Click to edit)</small>
                    </p>

                    <p class="card-text"><strong>Graduation Date:</strong> @Model.GraduationDate</p>
                    <p class="card-text"><strong>School Name:</strong> @Model.SchoolName</p>
                    <p class="card-text"><strong>Program Name:</strong> @Model.ProgramName</p>
                    <p class="card-text"><strong>Specialization:</strong> @Model.Specialization</p>
                    <p class="card-text"><strong>School Form:</strong> @Model.SchoolForm</p>
                    <p class="card-text"><strong>Curriculum:</strong> @Model.Curriculum</p>
                    <p class="card-text"><strong>Total points:</strong> <span id="totalPointsDisplay">@Model.TotalPoints</span></p>
                </div>
            </div>

            <h3 class="mt-4">Subjects</h3>
            <p class="text-muted">Please review and correct the grades below. It's essential that the grades are accurate for the record-keeping process.</p>

            <table class="table table-striped mt-2">
                <thead>
                    <tr>
                        <th>Subject Name</th>
                        <th>Course Code</th>
                        <th>Grade</th>
                        <th>Gymnasium Points</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var subject in Model.Subjects)
                    {
                        var isFuzzyMatch = subject.FuzzyMatchScore < 100.0;
                        var fuzzyScore = subject.FuzzyMatchScore;
                        var isBelowThreshold = fuzzyScore < 80.0;
                        var isUpdated = subject.OriginalSubjectName != null || subject.OriginalCourseCode != null || subject.OriginalGymnasiumPoints != null;

                        <tr class="@(isFuzzyMatch ? "table-warning" : "")"
                            data-id="@subject.SubjectName"
                            data-original-subject-name="@subject.OriginalSubjectName"
                            data-original-course-code="@subject.OriginalCourseCode"
                            data-original-points="@subject.OriginalGymnasiumPoints">

                            <td class="editable-cell @(isFuzzyMatch ? "needs-review" : "readonly-cell")" data-field="SubjectName" data-id="@subject.SubjectName">
                                @subject.SubjectName
                            </td>

                            <td class="editable-cell @(isFuzzyMatch ? "needs-review" : "readonly-cell")" data-field="CourseCode" data-id="@subject.SubjectName">
                                @(string.IsNullOrEmpty(subject.CourseCode) ? "N/A" : subject.CourseCode)
                            </td>
                            <td class="editable-cell" data-field="Grade" data-id="@subject.SubjectName">
                                @subject.Grade
                            </td>
                            <td class="editable-cell @(isFuzzyMatch ? "needs-review" : "readonly-cell")" data-field="GymnasiumPoints" data-id="@subject.SubjectName">
                                @(subject.GymnasiumPoints)
                            </td>
                        </tr>

                        @if (isFuzzyMatch && !isBelowThreshold)
                        {
                            <tr>
                                <td colspan="4">
                                    <div class="alert alert-info mt-2">
                                        <strong>Note:</strong> We are <strong>@fuzzyScore%</strong> sure that this is the correct match. Please review it carefully and confirm.
                                        @if (isUpdated)
                                        {
                                            <p class="mt-2">
                                                <em>The system has modified this course. If the original details seem more accurate, you can restore the original values below.</em>
                                            </p>
                                            <button class="btn btn-warning btn-sm restore-btn mt-2" data-subject="@subject.SubjectName">Restore Original</button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }

                        else if (isBelowThreshold)
                        {
                            <tr>
                                <td colspan="4">
                                    <div class="alert alert-danger mt-2">
                                        <strong>Attention:</strong> We could not find a match for this course. Please help us correct the details.
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
            <button id="saveChangesButton" class="btn btn-success mt-3" style="display:none;">Save Changes</button>
        }
        else
        {
            <div class="alert alert-warning mt-4" role="alert">
                Data could not be displayed due to low image reliability.
            </div>
        }
    
}
else
{
    <div class="alert alert-info mt-4" role="alert">
        No document details could be found.
    </div>
}
<a asp-action="Index" asp-controller="Home">Back to Documents</a>
